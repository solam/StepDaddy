<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <!--<script src="http://192.168.1.6:8080/target/target-script-min.js#anonymous"></script> mobile device debug -->
  <meta charset="UTF-8">

  <!-- prevent caching during/on dev context -->
  <meta HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
  <meta HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE">

  <title>Sounds & visuals generator - ...Loops</title><!-- Sequencer -->
  <link rel="stylesheet" href="../common/css/user.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="../common/lib/noUiSlider/nouislider.min.css" />  


  <style>

    .clear {
      clear: both;
    }

    .connected_client {
      float:left;
      width: 150px;
      height: 100px;
      border: 1px solid black;
      margin-top: 10px;
    }

   .golo {
      width:320px;
      display:inline-block;
      margin-bottom: 30px;
    }

  </style>
</head>
<body id="audiovis-gen">

    <select id="midiOut" class="selectpicker">
        <option value="">Not connected</option>
    </select>    


<div id="instructions"><!--audio server loaded Générateur sonore prêt<br/>-->
  <img class="rounded" style="" src="../common/images/Loops_logo.png"><!-- width="220" height="220" -->

  <!--<div class="ins-right gfx">
    <br/>To join <span>...Loops Jam Session</span>
    <br/>1) Connect to <span>Wi-Fi ssid</span>: <span>loops (no password)</span>
    <br/>2) On your <span>device Web browser</span> type: http://<span>10.42.0.1:8282/device/?rm/nomopo</span>
    <br/>or scan the provided QR code<img style="margin-top: 20px; position:absolute; top:-20px; right: 5px; /* top: 60px left: 72px*/" src="../website/loops-connect.png" />
  </div>-->

  <!--<div class="ins-right gfx" style="display:none; opacity:0;">
    <br/>Pour participer à l'<span>improvisation musicale:</span>
    <br/>1) Connecte-toi au <span>réseau Wi-Fi</span>: <span>loops (pas de mot de passe)</span>
    <br/>2) Sur ton <span>navigateur Web</span> tape l'adresse: http://<span>10.42.0.1:8282/device/?rm/nomopo</span>
    <br/>ou scan <img style="margin-top: 20px; position:absolute; top:-20px; right: 5px; /* top: 60px left: 72px*/" src="../website/loops-connect.png" />
  </div>-->

  <div class="ins-right gfx"><!--  style="display:none; opacity:0;" -->
  <!--<h2>Open <span>Electro</span>nic Music <span>Jam</span> <span>Session</span> #1</h2>-->
  <!--<span style="color: white; font-size:40px;">pas de session d'impro en cours, revenez à telle heure !</span>-->

    <script>
    /*  
    <br/>Pour participer à l'<span>improvisation musicale:</span>
    <br/>1) Connecte-toi au <span>réseau Wi-Fi</span>: <span>loops (pas de mot de passe)</span><!-- * z-vous loops.play votre ou http://192.168.2.24:8282/device/?rm/nomopo -->
    <br/>2) Sur ton <span>navigateur Web</span> tape l'adresse: http://<span>loops.play</span>
    <!--<br/><br/>* Si vous obtenez une @ IP erronée de type 169.254.x.x avec le DHCP, configurez en STATIQUE, comme suit:
    <br/>ip @: <span>192.168.2.x</span> [x: numéro aléatoire entre 30 et 240] subnet mask: <span>255.255.0.0</span> router: <span>192.168.2.1</span> dns: <span>192.168.2.1</span>
    <br/> galérez avec le DHCP -->
    <br/><div style="font-size: 20px; position:relative; top: 55px; left: 60%">Pour toute requête: <span>loops@solam.co</span></div><!-- left 50% for 1920px width -->
    <!--<span style="font-size: 0.65em; color: lightgrey;">Merci à Maël pour le "debug" du réseau Wi-Fi !</span>-->
    */
    </script>

  </div>

  <!--<div class="ins-right" style="display:none">
    <br/>Pour participer à l'<span>improvisation musicale:</span>
    <br/>1) Connectez-vous au <span>réseau Wi-Fi</span>: <span>FORMATION (pas de mot de passe)</span>
    <br/>2) Sur votre <span>navigateur Web</span> tapez l'adresse: <span>http://:8282/device/?rm/nomopo</span>
    <br/>
  </div>-->

  <div class="ins-right soundgen">
  <h1>Sound Generator</h1> <!--(browser tab) (1)-->
  <button id="button" type="button" class="golo" title="click this button if sound icon is off">audio disabled by default on Chrome 70+: need of a user gesture to allow Web Audio (Click me!)</button><!-- Play music (sound off by default on Chrome 70+) -->
  </div>  

  <div class="ins-right precuemixer">
    <h1>Pre-cue mixer</h1>
    <button id="precButton" type="button" class="golo" title="click this button if sound icon is off">audio disabled by default on Chrome 70+: need of a user gesture to allow Web Audio (Click me!)</button>
  </div>    

  <div class="ins-right" style="display:none">
    <br/>Pour participer à l'<span>improvisation musicale:</span><!--&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; performance musicale collective  -->
    <br/>1) Connectez-vous au <span>réseau Wi-Fi</span>: <span>trempolino public</span> (mot de passe: trempolino)<!--&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-->
    <br/>2) Sur votre <span>navigateur Web</span> tapez l'adresse: <span>http://10.10.10.124:8282/device/?rm/mopo</span><!--&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--><!-- ou http://loops:8282--> 
    <!--<br/>3) Sur la page ...Loops cliquez sur: <span>JOIN CURRENT APP SESSION</span>-->
    <br/><!--<br/>-->
  </div>

<!--Instructions--> <!--Conseils pour jouer de son instrument/contrôleur  : 
<br/>- tenir son smartphone en mode paysage-->

  <!--<div id="tips">
    <span class="taitol">Conseils:</span>
    <ul>
      <li>Si vous utilisez un <i>smartphone</i>:
       <ul>
        <li>tenez le en mode "paysage"</li>
        <li>configurez le de façon à ce que votre écran ne s'éteigne que toutes les 3 à 5 minutes</li>
        <li>pour le domaine loops.play désactivez la traduction automatique des pages Web de l'anglais vers le français</li>
       </ul> 
       <br/>
      <li>Si vous rencontrez des problèmes: </li>
        <ul>
          <li>rafraîchissez votre page Web <!--(ctrl+r ou f5 sur ordinateur <i>desktop</i>)--</li>
          <li>installez et utilisez le navigateur Google Chrome (...Loops ne semble pas fonctionner sous Apple iOS - Safari)</li>
          <li>vérifiez que votre appareil est compatible avec le Wi-Fi N (norme IEEE 802.11n) utilisé par le réseau local loops</li>
       </ul> 
    </ul>  
  </div>-->

<br/><br/><br/><br/>
</div><!-- ARTISTES-RESIDENTS - A8MN13mPde  / pwd: <span></span> -->


<button title="audio recorder (uncompressed wave file as output when stop pressed)" id='start_rec'>Start Rec</button>

  <div id="audio-server-status" class="greenborder">
    <div style="display:none;" id="audio-server-ready"></div>
    <span>Available channel(s)</span><!--  Instrument(s) disponible(s): Available slot(s) -->
    <div id="audio-server-available-slots"></div>
  </div>

  <img class="sound" id="soundicon" src=""><!-- ../common/images/sound_on.jpg -->


  <div id="roomId">
    <!--<div>
      <h1>Welcome to Step Daddy!</h1>
      <p>
        Step Daddy is a multi user collaborative step sequencer.
        Several users can connect with their mobile devices or desktops and play a step sequencer
        together hosted on one of the devices connected.
        One device will be able to act as the main controller for
        all sound controlling filter and pitch.
      </p>
      <h1>How to use it</h1>
      <p>
        <img src="../common/images/ipad_iphone_64.png" />
        <img src="../common/images/Nexus7.png" />
      </p>
      <p>
        You can connect up to <b>6 devices</b> (5 instruments and 1 FX panel) and each device will control a <br/><b>different instrument!</b><br/>
        Go ahead and open the following url on different devices<br/></p>
      <h2></h2>
      <p><b>FX Panel</b></p>
      <h2></h2>
      <br/><br/>
      <p class="copyright">
        This project was created during the Stockholm Music Hackday 2013
        <br/>and it was a collaboration of
        <a href="http://twitter.com/plan8_music" target="_blank">@Plan8_Music</a>,
        <a href="http://twitter.com/14islands" target="_blank">@14islands</a>,
        <a href="http://twitter.com/blog2t" target="_blank">@blog2t</a>
        and <a href="http://twitter.com/72lions" target="_blank">@72lions</a> </p>
        <p class="copyright">iOS icons by <a href="http://ashung.deviantart.com/" target="_blank">Hung Ashung</a></p>
    </div>-->

  </div>

  <section id="sequencer-view" class="main-display-grid">  
    <table>

    </table>
  </section>

    <div id="modifiers"></div>

  <!-- add AudioWorklet polyfill for older browsers here -->
  
  <!--<script src="../common/lib/babel-polyfill.6.9.1.min.js"></script>--><!-- regenerator-runtime.js -->
  <!--<script src="../common/lib/audioworklet-polyfill.js"></script>-->
  <script src="../common/scripts/additional.functions.js"></script>
  <script src="../common/lib/socket.io.js"></script>
  <script src="../common/lib/WAAClock-0-5-0.js"></script>  
  <script src="../common/lib/jquery-2.2.4.min.js"></script><!-- jquery-1.9.0.min.js -->
  <script src="../common/lib/wNumb.js"></script>
  <script src="../common/lib/noUiSlider/nouislider.min.js"></script>
  <!--<script type="text/javascript">var smoothie = {'requirePath':['/','./instruments/jsdrumsynth/']};</script>-->
  <script src="../common/lib/smoothie-master/standalone/require.js"></script>
  
  <script src="../common/scripts/namespaces.js"></script>
  <script src="../common/scripts/utils.js"></script>
  <script src="../common/scripts/mixins.eventtarget.js"></script>
  <script src="../common/scripts/mixins.wrapper.js"></script>
  <script src="../common/scripts/enum.events.js"></script>
  <script src="../common/scripts/net.connection.js"></script>
  <script src="../common/scripts/net.response.js"></script>
  <script src="../common/scripts/net.proxyrequest.js"></script>

  <script src="../sequencer/instruments/mrsynth.js"></script> <!-- tanguy -->
  <script src="../sequencer/instruments/websynth_dsp.js"></script>
  <script src="../sequencer/instruments/midi-synth-master/js/waveshaper.js"></script>
  <script src="../sequencer/instruments/midi-synth-master/js/synth.js"></script>
  <script src="../sequencer/instruments/jsdrumsynth/jsdrumsynth.js"></script>


  
  <!--<script src="../sequencer/instruments/viktor-nv1-engine/src/bundle.js"></script>-->

  <script src="scripts/instruments_config.js"></script>
  <script src="scripts/instruments_config_02.js"></script><!-- cumbersome to add a file for each session -->
  <script src="scripts/instruments_config_03.js"></script>
  <script src="scripts/instruments_config_04.js"></script>
  <script src="scripts/instruments_config_05.js"></script>

  <script src="../common/scripts/models.track.js"></script>
  <script src="../common/scripts/models.instrument.js"></script>
  <script src="../common/scripts/ui.slider.js"></script>

  <script src="../common/scripts/views.sequencerview.js"></script>
  
  <script src="scripts/browser-polyfill.min.js"></script>
  <script src="scripts/recorder.js"></script>
  <!--<script src="../common/scripts/midiclock.js"></script>-->
  <script src="scripts/sequencer.js"></script>

    

<!-- fspaAudioWorkletPolySynth/main.js" needs to be aware of new AudioContext() invokated in sequencer.js -->
<script src="../sequencer/instruments/fspaAudioWorkletPolySynth/main.js"></script>
<!-- sampler using AudioWorklet tentative -->
<!--<script src="../sequencer/instruments/audioWorkletSampler/audio-player-main.js"></script>-->


  <script src="scripts/mixer.js"></script>


  <script type="text/javascript">




    //*
    var recMode = 'manual'; // manual | auto  

    var audioc = window['audio_context'];
    var rec = new Recorder(audioc);

    if (recMode=='manual') {
      var startDate = new Date();
      window.startTime = startDate.getTime();
    } else {
      window.startTime = window.SEQ._audioServerStartTimestamp;
    }  

    function stopRec() {
      console.log('stop rec called');  
      rec.stop();
      rec.exportWAV(dlWav);
      rec.clear(); // non contiguous mode
    }  

    function dlWav(blob) {
      Recorder.forceDownload(blob, "rec_" + window.startTime + ".wav"); // window.SEQ._audioServerStartTimestamp
    }   

    if (recMode=='manual') {

      $('#start_rec').on('click', function (e) {
          e.preventDefault();
          $(this).text(function (_, text) {
              return text === 'Stop Rec' ? 'Start Rec' : 'Stop Rec';
          }).toggleClass('stop_rec');

        if ( $(this).hasClass("stop_rec") ) {   
          
          //window['audio_context'].context.resume(); 
          //rec.record();

          rec && window['audio_context'].context.resume() && rec.record();

          var startDate = new Date();
          window.startTime = startDate.getTime();
          console.log("manual start rec at", window.startTime);
        } else {
          stopRec();
          console.log("manual stop rec");  
        }
      });  


    } else {
      $("#start_rec").hide();
      rec.record();
      console.log("auto start rec");
    }

    /* show dialog ton confirm leaving browser page or not
      window.onbeforeunload = function(e) {
        if (recMode=='auto') {  
          stopRec();
          console.log("auto stop rec");
         } 
      console.log('page refresh called');      
      return 'current rec stopped - press yes to start a new recording';
    };

    /*
    $(window).unload(function() {
        console.log('? back putton pressed');
          alert('Handler for .unload() called.');
    }); 
    */


    var windowWidth = $(window).width();
    var windowWidth = Number(windowWidth)-3;

    $('#audiovis-gen').css('width', windowWidth);

    //console.log('windowWidth:', windowWidth);




    var state = history.state || {};
    var reloadCount = state.reloadCount || 0;
    if (performance.navigation.type === 1) { // Reload
        state.reloadCount = ++reloadCount;
        history.replaceState(state, null, document.URL);
    } else if (reloadCount) {
        delete state.reloadCount;
        reloadCount = 0;
        history.replaceState(state, null, document.URL);
    }

    /*
    if (reloadCount >= 2) {
        // Now, do whatever you want...
        alert('The page was reloaded more than twice!');
    } */

    //console.log('reloadCount, window.sessionId : ', reloadCount, window.sessionid );


    var relo = localStorage.getItem('rreellooaadd');  

    if ( typeof relo !== 'undefined' ) {
      if ( relo == 0 ) {
        reloadCount = 0;
        /*
        window.setTimeout(function () {    
          //window.open('http://'+ip+':8282/device/?'+window.roomId+'/0/nomopo', '_blank');
          window.open('http://'+ip+':8282/device/?'+window.roomId+'/nomopo/noptnseq', '_blank');
        }, 1000); 
        */  
      }  
    }



    //* comment this section for online version
    if ( typeof window.ip !== 'undefined' && window.ip.length > 0 ) {
      ip = window.ip;
      ip += ':8282'; // local version only
      window.ip2 = ip;
    } else {
      ip = '192.168.1.16'; // Beware hardcoded value! // '127.0.0.1:8282'
      ip += ':8282'; // local version only
      window.ip2 = ip;
    }
    // */


    //ip = 'loops.solam.co/editor'; // online version

    //console.log('window.ip', window.ip);

    //





    function popTabs(ip) {



          //*

          window.setTimeout(function () {    
            //window.open(window.comode+'://'+ip+':8282/device/?'+window.roomId+'/0', '_blank');
            var tab1 = window.open(window.comode+'://'+ip+'/device/?'+window.roomId+'/0/noptnseq', '_blank');
            //var tab1 = null;
          }, 500); 
    //*
          window.setTimeout(function () {    
            window.open(window.comode+'://'+ip+'/device/?'+window.roomId+'/2/noptnseq', '_blank');
          }, 4000); 

          window.setTimeout(function () {    
            window.open(window.comode+'://'+ip+'/device/?'+window.roomId+'/3/noptnseq', '_blank');
          }, 5500); 

          window.setTimeout(function () {    
            window.open(window.comode+'://'+ip+'/device/?'+window.roomId+'/4/noptnseq', '_blank');
          }, 7000);     

          window.setTimeout(function () {    
            window.open(window.comode+'://'+ip+'/device/?'+window.roomId+'/5/noptnseq', '_blank');
          }, 8500);    

          window.setTimeout(function () {    
            window.open(window.comode+'://'+ip+'/device/?'+window.roomId+'/6/noptnseq', '_blank');
          }, 10000);                          

          //*
          window.setTimeout(function () {
            window.open(window.comode+'://'+ip+'/device/?'+window.roomId+'/1', '_blank');        
          }, 11500);  
          //*/                   
    //*/
          //window.loadedTabs = 1; // beware multiple call to this page = keeps loading new tabs...

          //*/







  }



    document.querySelector('button').addEventListener('click', function() {
      window['audio_context'].context.resume().then(() => {
        console.log('Playback resumed successfully');
        $("#soundicon").attr("src","../common/images/sound_on.jpg");

        /*if ( reloadCount == 0 ) {
          console.log('Pop tabs');
          popTabs(window.ip2);
          localStorage.setItem("rreellooaadd", 1);
        }  */


      });
    });



      $('#precButton').on('click', function (e) {
        e.preventDefault();
        window['audio_context'].context.resume().then(() => {
          console.log('Playback resumed successfully');
          $("#soundicon").attr("src","../common/images/sound_on.jpg");
          localStorage.setItem("wac", 1); // Web Audio Context
        });
      });     

      $('#soundicon').on('click', function (e) {
        e.preventDefault();
        window['audio_context'].context.resume().then(() => {
          console.log('Playback resumed successfully');
          $("#soundicon").attr("src","../common/images/sound_on.jpg");
          localStorage.setItem("wac", 1); // Web Audio Context
        });
      });            



    setTimeout(function() { 

      if ( window['audio_context'].context.state == "running" ) {
        console.log(window['audio_context'].context.state);
        $("#soundicon").attr("src","../common/images/sound_on.jpg");

        localStorage.setItem("wac", 1); // Web Audio Context


      if ( typeof window.ptnmode !== 'undefined' && typeof window.roomId !== 'undefined' && typeof window.childRoom !== 'undefined' && typeof window.loadedTabs === 'undefined' 
        && reloadCount == 0) { 

        localStorage.setItem("rreellooaadd", 1);

        if ( window.ptnmode == 1 ) {
          popTabs(ip);
        }
      }

      } else {
        localStorage.setItem("rreellooaadd", 0);
        localStorage.setItem("wac", 0); // Web Audio Context

        $("#soundicon").attr("src","../common/images/sound_off.jpg");
        //location.reload(true); // (under Song editor on main page) 
        //alert('Please refresh page (ctrl + r / F5) AND quickly click "play music" button while page is loading');
        //alert('Click play music button (inside sound generator tab in song editor context) to start music');
        alert('Click speaker icon to enable audio output (inside sound generator tab in song editor context)');
        //window.rreellooaadd = 0;    
      }      




      
    }, 5000);     

  
    if ( typeof window.rumidi !== 'undefined' ) {
      $(".ins-right h1").append(' '+window.rumidi.substr(1));
    }



  </script>
</body>
</html>
